# Changelog

## 1.6.0beta5 2024-03-23

- fairycall を VoiSona Talk Editor 1.2.0.1 に合わせて調整
- VOICEPEAK 用 fairycall の処理速度を改善
- 起動時に fairycall が動作確認しているアプリケーションとバージョンを出力するようにした

## 1.6.0beta4 2024-03-15

- A.I.VOICE2 用 fairycall で書き出しボタン検索に失敗しやすかったのを修正

## 1.6.0beta3 2024-02-21

- A.I.VOICE 2.3.0 用 fairycall を実装

## 1.6.0beta2 2023-12-26

- 空のテキストファイルを受け入れるかどうかを設定する `acceptemptytext` をグローバルセクションに追加
  - 今までは無条件で受け入れていましたが、今後はデフォルトで受け入れません

## 1.6.0beta1 2023-11-29

- VoiSona Talk Editor 1.1.5.1 用 fairycall を実装
- `[[asas]]` で `flags = 0` のプロセスに対してはフックしないように改善

## 1.6.0alpha5 2023-06-15

- modifier の `execute` 関数に特別な識別子 `<IN>` と `<OUT>` を追加
  - `%BEFORE%` と `%AFTER%` のようなファイルでの受け渡しの代わりに、標準入力と標準出力でデータを受け渡します

## 1.6.0alpha4 2023-01-14

- VOICEPEAK 1.2.1 で入力欄検出が上手くいかないことがあるのを修正
- VOICEPEAK 1.2.1 で 96dpi 以外の環境でポップアップメニューが表示されなかった問題を修正

## 1.6.0alpha3 2023-01-13

- VOICEPEAK 1.2.1 のウィンドウサイズが小さいときに GUI オートメーションが動作していなかったのを修正

## 1.6.0alpha2 2023-01-13

- GUI オートメーションを VOICEPEAK 1.2.1 で動くように修正
  - VOICEPEAK 1.1.0b2 では動かなくなりました

## 1.6.0alpha1 2022-12-29

- GUI オートメーション機能を試験的に実装
  - グローバルセクションに `fairycall = "Alt + Ctrl + Shift + S"` のような設定を加えると使用できます
  - 現在は VOICEPEAK 1.1.0b2 専用で、ショートカットキーを押すと、アクティブなセリフブロックの保存処理を自動化します
- プログラムを 64bit 専用に変更

## 1.5.5 2022-04-20

- リトライ機構改良時の影響で無視すべきファイルの変更を追跡してしまっていたのを修正
- 同梱する asas のバージョンを更新

## 1.5.4 2022-04-17

- ファイルへの書き込み通知は freshness の設定に関わらず更新日時を検証する
  - 利用しているパッケージの仕様により属性変更なども書き込みとして通知されてしまう問題への対処
- 同梱する asas のバージョンを更新

## 1.5.3 2022-04-14

- 多重送信保護機能を改良

## 1.5.2 2022-04-11

- リトライ機構を改良
  - `読み取りに失敗しました: EOF` が出る頻度を減らした
  - VOICEPEAK と相性が良くなかったのを改善
- 同梱する asas のバージョンを更新

## 1.5.1 2022-04-08

- バージョン表記を3桁に変更
- 同梱する asas のバージョンを更新
- 設定の再読み込み時にログをクリアするようにした
  - 一気に上にスクロールしてログにあるその時点の設定内容を読み間違うのを防止するため
  - 起動時に `-prevent-clear` オプションを渡すと以前の動作に戻せます
- 同名ファイルの再送信保護の仕組みを改良
- 依存パッケージの更新
- ドキュメントにバージョン情報を埋め込み
- 配布パッケージの自動ビルド

## 1.5 2022-03-04

- 同梱する asas のバージョンを更新

## 1.4 2021-08-14

- `filere` が正しく動いていなかったのを修正

## 1.3 2021-08-12

- ファイル名の指定を正規表現で行える `filere` を追加
  - `filere = '''^.+?_琴葉 茜(?:| - .+?)_.*?\.[Ww][Aa][Vv]$'''` のように使います
  - `file` と同時に使用することはできません
- 英語化パッチが当たった AviUtl でも動くように改良
  - ごちゃまぜドロップス v0.3.25 以降が必要です

## 1.2 2021-05-24

- ルール検索時のフォルダー検証を改善
  - 以前は `C:\abc` や `C:\abc\` や `C:\ABC\` の違いで検証に失敗していた

## 1.1 2021-03-23

- 0.1beta18 での修正を更に軽減

## 1.0 2021−03-03

- GUI エディターのテスト版を削除

## 0.1rc6 2021-02-26

- テンプレートで ガイノイドTALK や A.I.VOICE への言及を追加
- テンプレートに destdir の設定例を追加
- GUI エディターを Per-Monitor (V2) DPI Awareness とダークモードに対応させた
- GUI エディターの細かなバグ修正とエラーチェックの強化

## 0.1rc5 2021-02-23

- setting.txt がなくても正常起動して待機できるように
- GUI エディターのテスト版を追加

## 0.1rc4 2021-01-19

- 旧形式のテンプレートで使い方を紹介している動画のために古いテンプレートを追加

## 0.1rc3 2020-11-16

- temp.exo の上書きが正しく行われていなかったのを修正

## 0.1rc2 2020-11-12

- SendMessage のエラーチェックを追加

## 0.1rc1 2020-09-18

- ログ出力をカラーにした
  - 起動時に `-m` オプションを付けると無効化できます
- エラーメッセージを改善
- グローバルに `sort` オプションと `sortdelay` オプションを追加
  - 複数の音声ファイルが一気に作成されたときに、どういう基準で並び替えるのかを決めるオプションです
- `destdir` オプションをグローバルと `[[rule]]` セクションに追加
  - ファイルの移動先を `*.aup` と同じフォルダー以外にもできるようになります
  - プロジェクトを丸ごと移動してもエラーを出さずに読み込めるのはデフォルト設定だけです
- `filemove` の設定を `[[rule]]` で上書きした場合に上手く動かないことがあったのを修正
- 移動元と移動先のフォルダーが同じかどうかの判定方法を改善
- ファイルのコピー、削除、名前の変更は一度の失敗では諦めないように変更
- ファイル名の変更で名前が衝突している場合に自動的に回避する機構を追加

## 0.1beta24 2020-09-08

- 処理失敗時の再試行が上手く動かなかったのを修正
- ファイル移動前に音声ファイルの内容を検証するように改善

## 0.1beta23 2020-08-31

- OSや環境に依存するフォルダーの場所を示す環境変数を追加
  - `%PROFILE%` - `C:\Users\YourName`
  - `%DESKTOP%` - `C:\Users\YourName\Desktop`
  - `%MYDOC%` - `C:\Users\YourName\Documents`
- modifier でのリネーム対象を `*.wav` `*.txt` だけでなく、あらゆる拡張子が対象になるように変更
  - ディレクトリ内のファイルを列挙する必要があるため負荷が上がるが、12000個ぐらいでは問題なさそうだった
- `filemove` が `move` や `copy` でも同じ場所が対象の場合は `off`として処理するように改善
- `movedelay` オプションをグローバルと `[[rule]]` セクションに追加
  - `filemove = "move"` の処理はコピー＆削除で実現しており、その削除を遅延させる時間、デフォルトで0秒
- たまに AviUtl がデッドロック状態になってしまうことがあったのを修正

## 0.1beta22 2020-08-30

- `[[asas]]` の `folder` と `[[rule]]` の `dir` で `%PROJECTDIR%` を利用可能にした
- 読み込んでいるプロジェクトファイルのパスが変わったときに設定を再読み込みするようにした

## 0.1beta21 2020-08-28

- 新しいexoファイルテンプレートシステムを実装
  - 最初のフレームに「字幕」と書いたテキストオブジェクトと、ファイルを読み込んでいない音声オブジェクトを置くだけで使用可能
- 以前のテンプレートシステム用のテンプレートファイルを削除

## 0.1beta20 2020-08-26

- github.com/pkg/errors への依存を削除
- setting.txt-template 内の `[[asas]]` と `[[rule]]` をデフォルトでコメントアウト
- exofile / luafile で `%BASEDIR%` `%TEMPDIR%` `%PROJECTDIR%` を使用可能にした

## 0.1beta19 2020-08-26

- exofile / luafile の仕組みが正しく動いていなかったのを修正
- オブジェクトの長さ計算を修正
- 起動時の状態出力を改善

## 0.1beta18 2020-08-24

- 大量のファイル操作が短時間に発生した際に内部バッファが溢れることがあったのを軽減

## 0.1beta17 2020-08-20

- 同梱する asas のバージョンを更新

## 0.1beta16 2020-08-19

- setting.txt の読み込み処理を作り直した
- `[[rule]]` に `filemove` と `deletetext` を書くことで設定を個別に上書きできるようにした

## 0.1beta15 2020-08-17

- カレントディレクトリが exe ファイルのフォルダーではないときに上手く動かなかった問題を修正
- グローバルセクションに `exofile=template.exo` と `luafile=genexo.lua` の設定を追加
  - 絶対パスで書けば外のフォルダーにおいたテンプレートファイルでも読み込めるはず（未テスト）
- グローバルセクションと `[[rule]]` セクションに `padding=0` の設定を追加
  - `padding` の設定を PSDToolKit で使うためには v0.2beta47 以降のバージョンが必要です
  - `*.exo` を生成する際は `__json=~~` というデータを埋め込まないと PSDToolKit が padding が認識できません
- `[[rule]]` セクションの `dir` が見つからなくても警告した上で処理を続行するように変更
- `[[rule]]` の `modifier` で `layer` `filename` `userdata` `exofile` `luafile` を動的に変更可能にした
  - `modifier` から代入すれば `userdata` に任意の型を格納できるようになった
- exe ファイルがあるフォルダーに `tmp` というフォルダーを自動生成するようにした
  - `[[rule]]` の `dir` に `%TEMPDIR%` を含むと `tmp` フォルダーに置換されるようにした
- `[[asas]]` で asas 用の定義を記述できるようにし、かんしくん起動時に連動起動できる機構を追加
- 設定ファイルの記述を簡略化するための変更
  - `[[rule]]` の `dir` のデフォルト値を `%TEMPDIR%` にした
  - `[[rule]]` の `encoding` のデフォルト値を `sjis` にした
- `genexo.lua` で新しく追加された設定値にアクセスできるように `gen` に代わり `gen2` を使えるようにした
  - `gen` を使ったスクリプトも依然として動作しますが、`padding` のような新しい設定値へのアクセス手段がありません。

`genexo.lua` の新しい仕様は以下のようなものです。

```lua
-- 文字エンコーディングは UTF-8 にしてください
local P = {}
-- 関数名が gen2 になり、引数が変わりました
-- 以前の layer と userdata は rule.layer, rule.userdata でアクセスでき、そのほか rule.padding などもあります
function P.gen2(proj, file, text, rule)
  local length = 30
  return tosjis("[exedit]\r\nwidth=1280\r\nheight=720\r\nrate=30\r\nscale=1\r\nlength=" .. length .. "..."), length
end
return P
```

## 0.1beta14 2020-06-25

- プログラムと同じフォルダーに `genexo.lua` を作成することで Lua で直接 `*.exo` の中身を生成できる仕組みを追加
- プログラムと同じフォルダーに `template.exo` を作成することで、カスタマイズされた `*.exo` を作れる仕組みを追加
- `[[rule]]` 内で `userdata = 'abcdef'` のように文字列を割り当てておくと `genexo.lua` で参照できる仕組みを追加

`genexo.lua` を作成する場合は概ね以下のような感じで、`*.exo` の内容になるテキストとカーソルを進めるフレーム数を返してください。

```lua
-- 文字エンコーディングは UTF-8 にしてください
local P = {}
function P.gen(proj, file, text, layer, userdata)
  local length = 30
  return tosjis("[exedit]\r\nwidth=1280\r\nheight=720\r\nrate=30\r\nscale=1\r\nlength=" .. length .. "..."), length
end
return P
```

## 0.1beta13 2020-06-25

- AviUtl のプロジェクトファイルと同じ場所に `*.wav` や `*.txt` を移せる `filemove` オプションを追加(ごちゃまぜドロップス v0.3.13 以降が必須)
- 処理後に不要になったテキストファイルを消す `deletetext` オプションを追加

## 0.1beta12 2019-03-17

- 文字コード UTF-16LE と UTF-16BE に対応
- modifier で外部コマンド実行の仕組みを追加
- 詳細モードで AviUtl 側のプロジェクト情報を出力するようにした
- その他軽微なバグを修正

## 0.1beta11 2018-05-13

- 定義されているルール設定をログに出力するようにした
  - setting.txt の文字コード間違いを視認できる場所を作るための措置です

## 0.1beta10 2018-05-13

- 詳細モードのログを更に詳しくした

## 0.1beta9 2018-04-27

- 数値のパラメーターで小数点を省くと panic していたのを修正
- delta や freshness に 0 を渡すと無効化できるはずが動いていなかったのを修正
  - 設定の省略時はそれぞれ 15 / 5 になり、明示的に 0 を渡すと無効化
- ログを見やすくなるように改善

## 0.1beta8 2018-04-26

- 特定の状況下で更新していないファイルが追加されてしまうバグを修正

## 0.1beta7 2018-04-26

- 更新日時が古いファイルを無視するための freshness オプションを追加
- 起動時に -v オプションを渡すことでより詳細なログを出力できるよう改善

## 0.1beta6 2018-04-18

- ファイルの読み込みに失敗した時にリトライするように改善
- エラー理由をもう少し詳細に出すように改善
- basedir でフォルダー名を集約できるように改善
- 起動したままでの setting.txt の書き換えに対応
- 64bit 版ではなく 32bit 版でリリースするように変更

## 0.1beta5 2018-04-13

- テキスト本文もルール定義に利用できるよう改善
- 投げ込む前にテキストを置換できるように改善
- 複数ファイル検出時に更新日時が古い順に並び替え

## 0.1beta4 2018-04-12

- 複数のフォルダーの監視に対応

## 0.1beta3 2018-04-12

- setting.txt での BOM を許容

## 0.1beta2 2018-04-12

- 同じファイルを連続で送らないように抑制

## 0.1beta 2018-04-12

- 初版
